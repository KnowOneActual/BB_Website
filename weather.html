<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Query Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for a cleaner look */
        #chat-window::-webkit-scrollbar {
            width: 6px;
        }

        #chat-window::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        #chat-window::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 3px;
        }

        #chat-window::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
    </style>
</head>

<body class="bg-slate-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl flex flex-col h-[90vh] my-4">
        <!-- Header -->
        <div class="p-4 border-b border-slate-200 bg-slate-50 rounded-t-2xl flex items-center space-x-3">
            <div class="relative flex items-center justify-center w-12 h-12 bg-blue-500 rounded-full text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-bold text-slate-800">Weather Query Bot</h1>
                <p id="status" class="text-sm text-slate-500">Connecting...</p>
            </div>
        </div>

        <!-- Chat Window -->
        <div id="chat-window" class="flex-1 p-6 overflow-y-auto space-y-6">
            <!-- Messages will be injected here -->
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="px-6 pb-2 hidden">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-slate-500" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                    </svg>
                </div>
                <div class="bg-slate-200 rounded-lg p-3">
                    <div class="flex items-center space-x-1">
                        <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"
                            style="animation-delay: 0s;"></span>
                        <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"
                            style="animation-delay: 0.1s;"></span>
                        <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"
                            style="animation-delay: 0.2s;"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Form -->
        <div class="p-4 border-t border-slate-200 bg-slate-50 rounded-b-2xl">
            <form id="chat-form" class="flex items-center space-x-3">
                <input type="text" id="chat-input" placeholder="Ask about the weather..."
                    class="flex-1 w-full px-4 py-3 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                    autocomplete="off">
                <button type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg transition-transform duration-200 active:scale-95 flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                    <span>Send</span>
                </button>
            </form>
            <div id="user-info" class="text-xs text-slate-400 pt-2 text-center truncate"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        // IMPORTANT: You must get your own free API key from a weather provider.
        // I recommend OpenWeatherMap: https://openweathermap.org/api
        const WEATHER_API_KEY = "REMOVED_API_KEY"; // <-- PASTE YOUR KEY HERE

        const GEMINI_API_KEY = ""; // No key needed if using Gemini Flash 2.0

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_FALLBACK_API_KEY", authDomain: "...", projectId: "..." };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'weather-bot-default';

        // --- DOM ELEMENTS ---
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const statusEl = document.getElementById('status');
        const typingIndicator = document.getElementById('typing-indicator');
        const userInfoEl = document.getElementById('user-info');

        // --- FIREBASE INITIALIZATION ---
        let db, auth;
        let userId = null;
        let unsubscribe; // To detach the Firestore listener later

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            statusEl.textContent = 'Authenticating...';

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    statusEl.textContent = 'Online';
                    userInfoEl.textContent = `User ID: ${userId}`;
                    loadChatHistory();
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        statusEl.textContent = 'Authentication Failed';
                        addMessage('bot', `I'm having trouble connecting. Please refresh the page. Error: ${error.message}`);
                    }
                }
            });

        } catch (e) {
            console.error("Firebase initialization failed:", e);
            statusEl.textContent = 'Error';
            addMessage('bot', `Failed to initialize the application. Please check the console for errors.`);
        }

        // --- CHAT FUNCTIONS ---

        function addMessage(sender, text, timestamp) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'items-start', 'space-x-3', 'max-w-lg');

            const time = timestamp ? new Date(timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

            if (sender === 'user') {
                messageDiv.classList.add('ml-auto', 'flex-row-reverse', 'space-x-reverse');
                messageDiv.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-semibold">U</div>
                    <div>
                        <div class="bg-blue-500 text-white p-3 rounded-lg rounded-br-none">
                            <p>${text}</p>
                        </div>
                        <span class="text-xs text-slate-400 mt-1 float-right">${time}</span>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center">
                         <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg>
                    </div>
                     <div>
                        <div class="bg-slate-200 p-3 rounded-lg rounded-bl-none">
                            <p>${text}</p>
                        </div>
                        <span class="text-xs text-slate-400 mt-1">${time}</span>
                    </div>
                `;
            }
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function setTyping(isTyping) {
            typingIndicator.style.display = isTyping ? 'block' : 'none';
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // --- FIRESTORE FUNCTIONS ---

        async function saveMessage(sender, text) {
            if (!userId) return;
            try {
                const messagesRef = collection(db, `artifacts/${appId}/users/${userId}/messages`);
                await addDoc(messagesRef, {
                    sender: sender,
                    text: text,
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Error saving message: ", error);
            }
        }

        function loadChatHistory() {
            if (!userId) return;

            // Unsubscribe from any previous listener
            if (unsubscribe) unsubscribe();

            chatWindow.innerHTML = ''; // Clear previous messages

            const messagesRef = collection(db, `artifacts/${appId}/users/${userId}/messages`);
            const q = query(messagesRef, orderBy("createdAt", "asc"));

            unsubscribe = onSnapshot(q, (snapshot) => {
                chatWindow.innerHTML = ''; // Clear and redraw all messages on update
                addMessage('bot', "Hello! Ask me anything about the weather. For example: 'What's the weather like in Tokyo?' or 'Is it cold in New York right now?'");
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    addMessage(data.sender, data.text, data.createdAt);
                });
            }, (error) => {
                console.error("Error loading chat history:", error);
                addMessage('bot', "Sorry, I couldn't load your chat history.");
            });
        }


        // --- AI & WEATHER API LOGIC ---

        async function getCityFromQuery(userQuery) {
            const prompt = `From the following user query, extract only the name of the city or location. If no city is mentioned, respond with "N/A". Do not add any extra text or punctuation. Query: "${userQuery}"`;

            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`Gemini API error: ${response.statusText}`);

            const result = await response.json();
            return result.candidates[0].content.parts[0].text.trim();
        }

        async function getWeatherData(city) {
            if (WEATHER_API_KEY === "YOUR_OPENWEATHERMAP_API_KEY") {
                throw new Error("Weather API key not configured.");
            }
            const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${WEATHER_API_KEY}&units=metric`;

            const response = await fetch(apiUrl);
            if (!response.ok) {
                if (response.status === 404) throw new Error(`I couldn't find a city named "${city}". Please check the spelling.`);
                throw new Error(`Weather API error: ${response.statusText}`);
            }
            const data = await response.json();
            // Simplify the data to send to the AI
            return {
                city: data.name,
                country: data.sys.country,
                temperature_celsius: data.main.temp,
                feels_like_celsius: data.main.feels_like,
                condition: data.weather[0].main,
                description: data.weather[0].description,
                humidity_percent: data.main.humidity,
                wind_speed_mps: data.wind.speed
            };
        }

        async function getAIWeatherAnalysis(userQuery, weatherData) {
            const prompt = `You are a friendly and helpful weather bot. A user asked: "${userQuery}". The current weather data for their requested location is: ${JSON.stringify(weatherData)}. 
            
            Based on this data, provide a conversational, one-paragraph response. Be natural and helpful. For example, if it's cold, you might suggest wearing a jacket. If it's windy, you might mention it's a bit blustery. Always include the main temperature and condition.`;

            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`Gemini API error: ${response.statusText}`);

            const result = await response.json();
            return result.candidates[0].content.parts[0].text.trim();
        }

        // --- EVENT HANDLERS ---

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userQuery = chatInput.value.trim();
            if (!userQuery || !userId) return;

            addMessage('user', userQuery, { seconds: Date.now() / 1000 });
            await saveMessage('user', userQuery);
            chatInput.value = '';
            setTyping(true);

            try {
                const city = await getCityFromQuery(userQuery);
                if (city === 'N/A') {
                    throw new Error("I'm sorry, I couldn't identify a city in your request. Could you please rephrase it?");
                }

                const weatherData = await getWeatherData(city);
                const botResponse = await getAIWeatherAnalysis(userQuery, weatherData);

                addMessage('bot', botResponse);
                await saveMessage('bot', botResponse);

            } catch (error) {
                console.error("Processing Error:", error);
                const errorMessage = error.message || "Something went wrong. Please try again.";
                addMessage('bot', errorMessage);
                await saveMessage('bot', errorMessage);
            } finally {
                setTyping(false);
            }
        });

    </script>
</body>

</html>